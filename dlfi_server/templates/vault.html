{% extends "base.html" %}

{% block title %}DLFI - {{ vault_name }}{% endblock %}

{% block header_left %}
<div class="vault-indicator">
	<div class="dot {{ 'encrypted' if encrypted else '' }}"></div>
	<span>{{ vault_name }}</span>
</div>
{% endblock %}

{% block header_right %}
<button class="btn btn-sm btn-secondary" onclick="App.showExtractorModal()">Extract</button>
<button class="btn btn-sm btn-secondary" onclick="App.showSettingsModal()">Settings</button>
<button class="btn btn-sm btn-secondary" onclick="App.showCreateNode('VAULT')">+ Vault</button>
<button class="btn btn-sm btn-secondary" onclick="App.showCreateNode('RECORD')">+ Record</button>
<button class="btn btn-sm btn-secondary" onclick="App.exportStatic()">Export</button>
<a href="/close" class="btn btn-sm btn-secondary">Close</a>
{% endblock %}

{% block content %}
<div class="vault-wrapper">
	<!-- Query Bar at Top -->
	<div class="query-bar">
		<div class="query-input-wrapper">
			<input type="text" 
				id="queryInput" 
				class="query-input" 
				placeholder="Search... (press / to focus, click ? for help)"
				autocomplete="off"
				spellcheck="false">
			<div id="autocompleteDropdown" class="autocomplete-dropdown hidden"></div>
		</div>
		<div class="view-toggle">
			<button class="view-btn active" data-view="gallery" onclick="App.setView('gallery')" title="Gallery View">▦</button>
			<button class="view-btn" data-view="list" onclick="App.setView('list')" title="List View">☰</button>
		</div>
		<button class="btn btn-secondary" id="queryHelpBtn" title="Query Help">?</button>
	</div>
	
	<!-- Main Layout: Sidebar + Results -->
	<div class="vault-body">
		<!-- Sidebar with Tree -->
		<aside class="sidebar">
			<div class="sidebar-header">
				<span class="sidebar-title">Structure</span>
				<button class="btn btn-sm btn-secondary" onclick="App.refreshTree()" title="Refresh">↻</button>
			</div>
			<div class="sidebar-body">
				<div class="tree" id="treeView">
					<div class="loading"><div class="spinner"></div></div>
				</div>
			</div>
		</aside>
		
		<!-- Results Area -->
		<div class="results-area">
			<div class="query-stats" id="queryStats">Loading...</div>
			
			<div class="results-container">
				<div class="results-list-wrapper" id="queryResults">
					<div class="loading"><div class="spinner"></div></div>
				</div>
				
				<div id="detailPanel" class="detail-panel hidden">
					<div class="detail-header" id="detailHeader"></div>
					<div class="detail-body" id="detailBody"></div>
				</div>
			</div>
		</div>
	</div>
</div>

<!-- Lightbox -->
<div id="lightbox" class="lightbox hidden">
	<button class="lightbox-close" id="lightboxClose">&times;</button>
	<div class="lightbox-content" id="lightboxContent"></div>
</div>
{% endblock %}

{% block modals %}
<!-- Create Node Modal -->
<div id="createNodeModal" class="modal-overlay hidden">
	<div class="modal">
		<div class="modal-header">
			<h2 class="modal-title">Create Node</h2>
		</div>
		<div class="modal-body">
			<div class="form-group">
				<label class="form-label">Type</label>
				<select id="createNodeType" class="form-input">
					<option value="VAULT">Vault (Folder)</option>
					<option value="RECORD">Record (Item)</option>
				</select>
			</div>
			<div class="form-group">
				<label class="form-label">Path</label>
				<input type="text" id="createNodePath" class="form-input" placeholder="path/to/node">
				<p class="form-hint">Full path including parent folders</p>
			</div>
		</div>
		<div class="modal-footer">
			<button class="btn btn-secondary" onclick="document.getElementById('createNodeModal').classList.add('hidden')">Cancel</button>
			<button class="btn btn-primary" onclick="App.createNode()">Create</button>
		</div>
	</div>
</div>

<!-- Add Tag Modal -->
<div id="addTagModal" class="modal-overlay hidden">
	<div class="modal">
		<div class="modal-header">
			<h2 class="modal-title">Add Tag</h2>
		</div>
		<div class="modal-body">
			<div class="form-group">
				<label class="form-label">Tag</label>
				<input type="text" id="newTagInput" class="form-input" placeholder="Enter tag">
			</div>
		</div>
		<div class="modal-footer">
			<button class="btn btn-secondary" onclick="document.getElementById('addTagModal').classList.add('hidden')">Cancel</button>
			<button class="btn btn-primary" onclick="App.addTag()">Add</button>
		</div>
	</div>
</div>

<!-- Metadata Editor Modal -->
<div id="metadataEditorModal" class="modal-overlay hidden">
	<div class="modal modal-lg">
		<div class="modal-header">
			<h2 class="modal-title">Edit Metadata</h2>
		</div>
		<div class="modal-body">
			<p class="form-hint mb-3">Edit the JSON metadata. Supports nested objects and arrays.</p>
			<div id="metadataEditorError" class="alert alert-error hidden mb-3"></div>
			<textarea id="metadataJsonEditor" class="form-input metadata-editor" spellcheck="false"></textarea>
		</div>
		<div class="modal-footer">
			<button class="btn btn-secondary" onclick="document.getElementById('metadataEditorModal').classList.add('hidden')">Cancel</button>
			<button class="btn btn-primary" onclick="App.saveMetadata()">Save</button>
		</div>
	</div>
</div>

<!-- Query Help Modal -->
<div id="queryHelpModal" class="modal-overlay hidden">
	<div class="modal modal-xl">
		<div class="modal-header">
			<h2 class="modal-title">Query Syntax Help</h2>
		</div>
		<div class="modal-body" id="queryHelpContent">
			<div class="loading"><div class="spinner"></div></div>
		</div>
		<div class="modal-footer">
			<button class="btn btn-primary" onclick="document.getElementById('queryHelpModal').classList.add('hidden')">Close</button>
		</div>
	</div>
</div>

<!-- Settings Modal -->
<div id="settingsModal" class="modal-overlay hidden">
	<div class="modal modal-lg">
		<div class="modal-header">
			<h2 class="modal-title">Vault Settings</h2>
		</div>
		<div class="modal-body">
			<div id="settingsError" class="alert alert-error hidden mb-3"></div>
			<div id="settingsSuccess" class="alert alert-success hidden mb-3"></div>
			
			<!-- Encryption Section -->
			<div class="settings-section">
				<h3 class="settings-section-title">Encryption</h3>
				<div id="encryptionStatus" class="settings-status"></div>
				
				<div id="encryptionEnable" class="settings-form hidden">
					<p class="form-hint mb-3">Enable encryption to protect your vault with a password.</p>
					<div class="form-group">
						<label class="form-label">New Password</label>
						<input type="password" id="enableEncryptionPassword" class="form-input" placeholder="Enter password">
					</div>
					<div class="form-group">
						<label class="form-label">Confirm Password</label>
						<input type="password" id="enableEncryptionConfirm" class="form-input" placeholder="Confirm password">
					</div>
					<button class="btn btn-primary" onclick="App.enableEncryption()">Enable Encryption</button>
				</div>
				
				<div id="encryptionManage" class="settings-form hidden">
					<div class="settings-actions">
						<button class="btn btn-secondary" onclick="App.showChangePassword()">Change Password</button>
						<button class="btn btn-danger" onclick="App.showDisableEncryption()">Disable Encryption</button>
					</div>
					
					<div id="changePasswordForm" class="hidden mt-3">
						<div class="form-group">
							<label class="form-label">Current Password</label>
							<input type="password" id="currentPassword" class="form-input" placeholder="Current password">
						</div>
						<div class="form-group">
							<label class="form-label">New Password</label>
							<input type="password" id="newPassword" class="form-input" placeholder="New password">
						</div>
						<div class="form-group">
							<label class="form-label">Confirm New Password</label>
							<input type="password" id="confirmNewPassword" class="form-input" placeholder="Confirm new password">
						</div>
						<button class="btn btn-primary" onclick="App.changePassword()">Change Password</button>
						<button class="btn btn-secondary" onclick="App.hideChangePassword()">Cancel</button>
					</div>
					
					<div id="disableEncryptionForm" class="hidden mt-3">
						<p class="text-error mb-3">Warning: This will decrypt all files. This operation cannot be undone.</p>
						<div class="form-group">
							<label class="form-label">Current Password</label>
							<input type="password" id="disableEncryptionPassword" class="form-input" placeholder="Enter current password">
						</div>
						<button class="btn btn-danger" onclick="App.disableEncryption()">Disable Encryption</button>
						<button class="btn btn-secondary" onclick="App.hideDisableEncryption()">Cancel</button>
					</div>
				</div>
			</div>
			
			<!-- Partition Section -->
			<div class="settings-section">
				<h3 class="settings-section-title">File Partitioning</h3>
				<p class="form-hint mb-3">Split large files into smaller chunks. Useful for Git hosting limits.</p>
				<div class="form-group">
					<label class="form-label">Partition Size (MB)</label>
					<input type="number" id="partitionSizeMb" class="form-input" min="0" placeholder="50">
					<p class="form-hint">Set to 0 to disable partitioning. Minimum 1MB if enabled.</p>
				</div>
				<button class="btn btn-primary" onclick="App.updatePartitionSize()">Update Partition Size</button>
			</div>
		</div>
		<div class="modal-footer">
			<button class="btn btn-secondary" onclick="App.closeSettingsModal()">Close</button>
		</div>
	</div>
</div>

<!-- Extractor Modal -->
<div id="extractorModal" class="modal-overlay hidden">
	<div class="modal modal-lg">
		<div class="modal-header">
			<h2 class="modal-title">Run Extractor</h2>
		</div>
		<div class="modal-body">
			<div id="extractorError" class="alert alert-error hidden mb-3"></div>
			<div id="extractorSuccess" class="alert alert-success hidden mb-3"></div>
			
			<div class="form-group">
				<label class="form-label">URL</label>
				<input type="text" id="extractorUrl" class="form-input" placeholder="https://example.com/...">
			</div>
			
			<div class="form-group">
				<label class="form-label">Extractor</label>
				<select id="extractorSelect" class="form-input" onchange="App.loadExtractorConfig()">
					<option value="">Auto-detect</option>
				</select>
			</div>
			
			<div class="form-group">
				<label class="form-label">Cookies File Path <span class="form-label-hint">(optional)</span></label>
				<input type="text" id="extractorCookies" class="form-input" placeholder="C:\path\to\cookies.txt">
			</div>
			
			<div id="extractorConfigSection" class="hidden">
				<div class="form-group">
					<label class="form-label">Configuration</label>
					<div id="extractorConfigFields"></div>
				</div>
			</div>
			
			<div id="extractorProgress" class="hidden">
				<div class="progress-info">
					<span class="spinner-small"></span>
					<span>Extracting...</span>
				</div>
			</div>
		</div>
		<div class="modal-footer">
			<button class="btn btn-secondary" onclick="App.closeExtractorModal()">Cancel</button>
			<button class="btn btn-primary" id="runExtractorBtn" onclick="App.runExtractor()">Run Extractor</button>
		</div>
	</div>
</div>

<!-- Add Relationship Modal -->
<div id="addRelationshipModal" class="modal-overlay hidden">
	<div class="modal">
		<div class="modal-header">
			<h2 class="modal-title">Add Relationship</h2>
		</div>
		<div class="modal-body">
			<div id="addRelError" class="alert alert-error hidden mb-3"></div>
			<div class="form-group">
				<label class="form-label">Relationship Type</label>
				<input type="text" id="relationType" class="form-input" placeholder="e.g., AUTHORED_BY" list="relationTypesList">
				<datalist id="relationTypesList"></datalist>
			</div>
			<div class="form-group">
				<label class="form-label">Target Path</label>
				<input type="text" id="relationTarget" class="form-input" placeholder="path/to/target" list="relationTargetsList">
				<datalist id="relationTargetsList"></datalist>
			</div>
		</div>
		<div class="modal-footer">
			<button class="btn btn-secondary" onclick="App.closeAddRelationshipModal()">Cancel</button>
			<button class="btn btn-primary" onclick="App.addRelationship()">Add Relationship</button>
		</div>
	</div>
</div>

<!-- Context Menu -->
<div id="contextMenu" class="context-menu hidden">
	<div class="context-menu-item" onclick="App.contextAction('open')">Open</div>
	<div class="context-menu-item" onclick="App.contextAction('addTag')">Add Tag</div>
	<div class="context-menu-item" onclick="App.contextAction('addRelationship')">Add Relationship</div>
	<div class="context-menu-divider"></div>
	<div class="context-menu-item" onclick="App.contextAction('delete')">Delete</div>
</div>

<!-- Bulk Edit Modal -->
<div id="bulkEditModal" class="modal-overlay hidden">
	<div class="modal modal-lg">
		<div class="modal-header">
			<h2 class="modal-title">Bulk Edit (<span id="bulkEditCount">0</span> items)</h2>
		</div>
		<div class="modal-body">
			<div id="bulkEditError" class="alert alert-error hidden mb-3"></div>
			<div id="bulkEditSuccess" class="alert alert-success hidden mb-3"></div>
			
			<!-- Bulk Add Tags -->
			<div class="bulk-section">
				<h3 class="bulk-section-title">Add Tags</h3>
				<div class="form-group">
					<input type="text" id="bulkAddTagsInput" class="form-input" placeholder="tag1, tag2, tag3">
					<button class="btn btn-primary mt-2" onclick="App.bulkAddTags()">Add Tags to All</button>
				</div>
			</div>
			
			<!-- Bulk Remove Tags -->
			<div class="bulk-section">
				<h3 class="bulk-section-title">Remove Tags</h3>
				<div class="form-group">
					<input type="text" id="bulkRemoveTagsInput" class="form-input" placeholder="tag1, tag2, tag3">
					<button class="btn btn-secondary mt-2" onclick="App.bulkRemoveTags()">Remove Tags from All</button>
				</div>
			</div>
			
			<!-- Bulk Add Relationship -->
			<div class="bulk-section">
				<h3 class="bulk-section-title">Add Relationship</h3>
				<div class="form-group">
					<label class="form-label">Relationship Type</label>
					<input type="text" id="bulkRelationType" class="form-input" placeholder="e.g., PART_OF" list="bulkRelationTypesList">
					<datalist id="bulkRelationTypesList"></datalist>
				</div>
				<div class="form-group">
					<label class="form-label">Target Path</label>
					<input type="text" id="bulkRelationTarget" class="form-input" placeholder="path/to/target" list="bulkRelationTargetsList">
					<datalist id="bulkRelationTargetsList"></datalist>
				</div>
				<button class="btn btn-primary" onclick="App.bulkAddRelationship()">Add Relationship to All</button>
			</div>
			
			<!-- Bulk Add Metadata -->
			<div class="bulk-section">
				<h3 class="bulk-section-title">Merge Metadata</h3>
				<div class="form-group">
					<textarea id="bulkMetadataInput" class="form-input metadata-editor-small" placeholder='{"key": "value"}'></textarea>
					<button class="btn btn-primary mt-2" onclick="App.bulkAddMetadata()">Merge Metadata to All</button>
				</div>
			</div>
			
			<!-- Bulk Delete -->
			<div class="bulk-section bulk-section-danger">
				<h3 class="bulk-section-title">Delete All Selected</h3>
				<button class="btn btn-danger" onclick="App.bulkDelete()">Delete Selected Items</button>
			</div>
		</div>
		<div class="modal-footer">
			<button class="btn btn-secondary" onclick="App.closeBulkEditModal()">Close</button>
		</div>
	</div>
</div>

{% endblock %}

{% block scripts %}
<script>
document.getElementById('newTagInput')?.addEventListener('keypress', (e) => {
	if (e.key === 'Enter') App.addTag();
});

document.getElementById('createNodePath')?.addEventListener('keypress', (e) => {
	if (e.key === 'Enter') App.createNode();
});

document.getElementById('extractorUrl')?.addEventListener('keypress', (e) => {
	if (e.key === 'Enter') App.runExtractor();
});
</script>
{% endblock %}
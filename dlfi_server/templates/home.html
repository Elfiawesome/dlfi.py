{% extends "base.html" %}

{% block title %}DLFI - Select Vault{% endblock %}

{% block content %}
<div class="home-page">
	<div class="home-container">
		<div class="home-header">
			<h1 class="home-title">DLFI Vault Manager</h1>
			<p class="home-subtitle">Select an existing vault or create a new one</p>
		</div>
		
		<div id="alertContainer"></div>
		
		<div class="home-grid">
			<!-- Left Column: Existing Vaults -->
			<div class="home-column">
				<!-- Vaults in default directory -->
				<div class="section">
					<div class="section-header">
						<span class="section-title">Default Directory</span>
						<span class="section-path">{{ default_dir }}</span>
					</div>
					<div class="vault-list" id="defaultVaultsList">
						<div class="vault-list-empty">
							<p>No vaults in default directory</p>
						</div>
					</div>
				</div>
				
				<!-- Recent vaults from other locations -->
				<div class="section" id="recentVaultsSection" style="display: none;">
					<div class="section-header">
						<span class="section-title">Recent Vaults</span>
					</div>
					<div class="vault-list" id="recentVaultsList">
					</div>
				</div>
			</div>
			
			<!-- Right Column: Open/Create -->
			<div class="home-column">
				<!-- Open from path -->
				<div class="section">
					<div class="section-header">
						<span class="section-title">Open Vault</span>
					</div>
					<div class="section-body">
						<div class="form-group">
							<label class="form-label">Path</label>
							<div class="input-row">
								<input type="text" id="openVaultPath" class="form-input" placeholder="C:\path\to\vault">
								<button class="btn btn-secondary" onclick="showBrowser('open')">Browse</button>
							</div>
						</div>
						<div class="form-group">
							<label class="form-label">Password <span class="form-label-hint">(if encrypted)</span></label>
							<input type="password" id="openVaultPassword" class="form-input" placeholder="Leave empty if not encrypted">
						</div>
						<button class="btn btn-primary btn-block" onclick="openVaultFromPath()">Open Vault</button>
					</div>
				</div>
				
				<!-- Create new vault -->
				<div class="section">
					<div class="section-header">
						<span class="section-title">Create New Vault</span>
					</div>
					<div class="section-body">
						<div class="form-group">
							<div class="toggle-group">
								<label class="toggle-option">
									<input type="radio" name="createLocation" value="default" checked onchange="toggleCreateMode()">
									<span>In default directory</span>
								</label>
								<label class="toggle-option">
									<input type="radio" name="createLocation" value="custom" onchange="toggleCreateMode()">
									<span>Custom path</span>
								</label>
							</div>
						</div>
						
						<div id="createDefaultMode">
							<div class="form-group">
								<label class="form-label">Vault Name</label>
								<input type="text" id="newVaultName" class="form-input" placeholder="my-vault">
							</div>
						</div>
						
						<div id="createCustomMode" class="hidden">
							<div class="form-group">
								<label class="form-label">Full Path</label>
								<div class="input-row">
									<input type="text" id="newVaultPath" class="form-input" placeholder="C:\path\to\new-vault">
									<button class="btn btn-secondary" onclick="showBrowser('create')">Browse</button>
								</div>
							</div>
						</div>
						
						<div class="form-group">
							<label class="form-label">Password <span class="form-label-hint">(optional, enables encryption)</span></label>
							<input type="password" id="newVaultPassword" class="form-input" placeholder="Leave empty for no encryption">
						</div>
						<button class="btn btn-primary btn-block" onclick="createVault()">Create Vault</button>
					</div>
				</div>
			</div>
		</div>
	</div>
</div>

<!-- Password Modal -->
<div id="passwordModal" class="modal-overlay hidden">
	<div class="modal">
		<div class="modal-header">
			<h2 class="modal-title">Enter Password</h2>
		</div>
		<div class="modal-body">
			<p class="text-secondary mb-3">This vault is encrypted. Enter the password to open it.</p>
			<div class="form-group">
				<label class="form-label">Password</label>
				<input type="password" id="vaultPassword" class="form-input" placeholder="Enter password">
			</div>
			<div id="passwordError" class="alert alert-error hidden"></div>
		</div>
		<div class="modal-footer">
			<button class="btn btn-secondary" onclick="closePasswordModal()">Cancel</button>
			<button class="btn btn-primary" onclick="submitPassword()">Unlock</button>
		</div>
	</div>
</div>

<!-- File Browser Modal -->
<div id="browserModal" class="modal-overlay hidden">
	<div class="modal modal-lg">
		<div class="modal-header">
			<h2 class="modal-title">Browse</h2>
		</div>
		<div class="modal-body">
			<div class="browser-path-row">
				<input type="text" id="browserCurrentPath" class="form-input" placeholder="Path">
				<button class="btn btn-secondary" onclick="navigateTo(document.getElementById('browserCurrentPath').value)">Go</button>
			</div>
			<div class="browser-list" id="browserList">
				<div class="loading"><div class="spinner"></div></div>
			</div>
		</div>
		<div class="modal-footer">
			<button class="btn btn-secondary" onclick="closeBrowserModal()">Cancel</button>
			<button class="btn btn-primary" onclick="selectBrowserPath()">Select This Folder</button>
		</div>
	</div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Vault data passed safely as JSON - this preserves backslashes correctly
const DEFAULT_VAULTS = {{ default_vaults | tojson }};
const RECENT_VAULTS = {{ recent_vaults | tojson }};

let pendingVaultPath = null;
let browserMode = null;
let browserCurrentPath = '';

// Store browser items to avoid path escaping issues
let browserItems = [];

function escapeHtml(text) {
	if (text === null || text === undefined) return '';
	const div = document.createElement('div');
	div.textContent = String(text);
	return div.innerHTML;
}

function showAlert(message, type = 'error') {
	const container = document.getElementById('alertContainer');
	container.innerHTML = `<div class="alert alert-${type}">${escapeHtml(message)}</div>`;
	setTimeout(() => container.innerHTML = '', 5000);
}

// Render vault lists on page load
function renderVaultLists() {
	const defaultList = document.getElementById('defaultVaultsList');
	const recentList = document.getElementById('recentVaultsList');
	const recentSection = document.getElementById('recentVaultsSection');
	
	// Render default vaults
	if (DEFAULT_VAULTS && DEFAULT_VAULTS.length > 0) {
		defaultList.innerHTML = '';
		DEFAULT_VAULTS.forEach((vault, index) => {
			const item = document.createElement('div');
			item.className = 'vault-item';
			item.onclick = () => openVaultByIndex('default', index);
			item.innerHTML = `
				<div class="vault-item-left">
					<div class="vault-item-icon">üìÅ</div>
					<span class="vault-item-name">${escapeHtml(vault.name)}</span>
				</div>
				${vault.encrypted ? '<span class="vault-item-badge">üîí</span>' : ''}
			`;
			defaultList.appendChild(item);
		});
	}
	
	// Render recent vaults
	if (RECENT_VAULTS && RECENT_VAULTS.length > 0) {
		recentSection.style.display = 'block';
		recentList.innerHTML = '';
		RECENT_VAULTS.forEach((vault, index) => {
			const item = document.createElement('div');
			item.className = 'vault-item';
			item.onclick = () => openVaultByIndex('recent', index);
			item.innerHTML = `
				<div class="vault-item-left">
					<div class="vault-item-icon">üìÅ</div>
					<div class="vault-item-info">
						<span class="vault-item-name">${escapeHtml(vault.name)}</span>
						<span class="vault-item-path">${escapeHtml(vault.path)}</span>
					</div>
				</div>
				${vault.encrypted ? '<span class="vault-item-badge">üîí</span>' : ''}
			`;
			recentList.appendChild(item);
		});
	}
}

function openVaultByIndex(listType, index) {
	const list = listType === 'default' ? DEFAULT_VAULTS : RECENT_VAULTS;
	if (list && list[index]) {
		const vault = list[index];
		openVault(vault.path, vault.encrypted);
	}
}

function toggleCreateMode() {
	const useDefault = document.querySelector('input[name="createLocation"]:checked').value === 'default';
	document.getElementById('createDefaultMode').classList.toggle('hidden', !useDefault);
	document.getElementById('createCustomMode').classList.toggle('hidden', useDefault);
}

function openVault(path, encrypted) {
	console.log('Opening vault:', path, 'encrypted:', encrypted);
	
	if (encrypted) {
		pendingVaultPath = path;
		document.getElementById('vaultPassword').value = '';
		document.getElementById('passwordError').classList.add('hidden');
		document.getElementById('passwordModal').classList.remove('hidden');
		document.getElementById('vaultPassword').focus();
		return;
	}
	
	doOpenVault(path, null);
}

function openVaultFromPath() {
	const path = document.getElementById('openVaultPath').value.trim();
	const password = document.getElementById('openVaultPassword').value || null;
	
	if (!path) {
		showAlert('Please enter a vault path');
		return;
	}
	
	doOpenVault(path, password);
}

async function doOpenVault(path, password) {
	console.log('doOpenVault:', path, 'password:', password ? '(set)' : '(none)');
	
	try {
		const resp = await fetch('/api/vault/open', {
			method: 'POST',
			headers: { 'Content-Type': 'application/json' },
			body: JSON.stringify({ path: path, password: password })
		});
		
		const data = await resp.json();
		console.log('Response:', resp.status, data);
		
		if (!resp.ok) {
			throw new Error(data.error || 'Failed to open vault');
		}
		
		window.location.href = '/vault';
	} catch (e) {
		console.error('Open vault error:', e);
		if (pendingVaultPath) {
			document.getElementById('passwordError').textContent = e.message;
			document.getElementById('passwordError').classList.remove('hidden');
		} else {
			showAlert(e.message);
		}
	}
}

function closePasswordModal() {
	document.getElementById('passwordModal').classList.add('hidden');
	pendingVaultPath = null;
}

function submitPassword() {
	const password = document.getElementById('vaultPassword').value || null;
	doOpenVault(pendingVaultPath, password);
}

async function createVault() {
	const useDefault = document.querySelector('input[name="createLocation"]:checked').value === 'default';
	const password = document.getElementById('newVaultPassword').value || null;
	
	let body = { password: password };
	
	if (useDefault) {
		const name = document.getElementById('newVaultName').value.trim();
		if (!name) {
			showAlert('Please enter a vault name');
			return;
		}
		body.name = name;
		body.use_default_dir = true;
	} else {
		const path = document.getElementById('newVaultPath').value.trim();
		if (!path) {
			showAlert('Please enter a vault path');
			return;
		}
		body.path = path;
	}
	
	console.log('Creating vault:', body);
	
	try {
		const resp = await fetch('/api/vault/create', {
			method: 'POST',
			headers: { 'Content-Type': 'application/json' },
			body: JSON.stringify(body)
		});
		
		const data = await resp.json();
		console.log('Response:', resp.status, data);
		
		if (!resp.ok) {
			throw new Error(data.error || 'Failed to create vault');
		}
		
		window.location.href = '/vault';
	} catch (e) {
		console.error('Create vault error:', e);
		showAlert(e.message);
	}
}

// File browser
function showBrowser(mode) {
	browserMode = mode;
	document.getElementById('browserModal').classList.remove('hidden');
	navigateTo('');
}

function closeBrowserModal() {
	document.getElementById('browserModal').classList.add('hidden');
	browserMode = null;
}

async function navigateTo(path) {
	const list = document.getElementById('browserList');
	list.innerHTML = '<div class="loading"><div class="spinner"></div></div>';
	
	try {
		const resp = await fetch('/api/vault/browse', {
			method: 'POST',
			headers: { 'Content-Type': 'application/json' },
			body: JSON.stringify({ path: path || '' })
		});
		
		const data = await resp.json();
		
		if (!resp.ok) {
			throw new Error(data.error || 'Failed to browse');
		}
		
		browserCurrentPath = data.current || '';
		document.getElementById('browserCurrentPath').value = browserCurrentPath;
		
		// Store items array for safe access
		browserItems = data.items || [];
		
		if (browserItems.length === 0) {
			list.innerHTML = '<div class="browser-empty">No items found</div>';
			return;
		}
		
		// Build DOM elements to avoid escaping issues
		list.innerHTML = '';
		browserItems.forEach((item, index) => {
			const div = document.createElement('div');
			div.className = 'browser-item' + (item.is_vault ? ' is-vault' : '');
			if (item.is_dir) {
				div.onclick = () => navigateToIndex(index);
			}
			div.innerHTML = `
				<span class="browser-item-icon">${item.is_dir ? 'üìÅ' : 'üìÑ'}</span>
				<span class="browser-item-name">${escapeHtml(item.name)}</span>
				${item.is_vault ? '<span class="browser-item-badge">VAULT</span>' : ''}
			`;
			list.appendChild(div);
		});
		
	} catch (e) {
		console.error('Browse error:', e);
		list.innerHTML = `<div class="browser-empty">Error: ${escapeHtml(e.message)}</div>`;
	}
}

function navigateToIndex(index) {
	if (browserItems[index]) {
		navigateTo(browserItems[index].path);
	}
}

function selectBrowserPath() {
	if (!browserCurrentPath) return;
	
	if (browserMode === 'open') {
		document.getElementById('openVaultPath').value = browserCurrentPath;
	} else if (browserMode === 'create') {
		document.getElementById('newVaultPath').value = browserCurrentPath;
	}
	
	closeBrowserModal();
}

// Enter key handlers
document.addEventListener('DOMContentLoaded', () => {
	renderVaultLists();
	
	document.getElementById('vaultPassword')?.addEventListener('keypress', (e) => {
		if (e.key === 'Enter') submitPassword();
	});
	
	document.getElementById('openVaultPath')?.addEventListener('keypress', (e) => {
		if (e.key === 'Enter') openVaultFromPath();
	});
	
	document.getElementById('openVaultPassword')?.addEventListener('keypress', (e) => {
		if (e.key === 'Enter') openVaultFromPath();
	});
	
	document.getElementById('newVaultName')?.addEventListener('keypress', (e) => {
		if (e.key === 'Enter') createVault();
	});
	
	document.getElementById('newVaultPath')?.addEventListener('keypress', (e) => {
		if (e.key === 'Enter') createVault();
	});
	
	document.getElementById('newVaultPassword')?.addEventListener('keypress', (e) => {
		if (e.key === 'Enter') createVault();
	});
	
	document.getElementById('browserCurrentPath')?.addEventListener('keypress', (e) => {
		if (e.key === 'Enter') navigateTo(e.target.value);
	});
});
</script>
{% endblock %}